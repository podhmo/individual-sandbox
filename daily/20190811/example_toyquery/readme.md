## toyquery

- https://github.com/podhmo/toyquery

作っていきたい。

## 元々の気持ち

go-webtestでほとんどnet/httpにしか依存しない様にコードが書けても裏側のDBチェックとかがベタ書きだとあんまり嬉しくないかも。

加えてDBチェックのときに使うqueryは結構単純な物が多いのでフルの機能は要らないかもだし。reflectはゆるされそうな感じ。

今回のモットーは「テストコードのカバレッジは常に100%」という感じかも。

## 方針的なもの

そこそこいい感じにdb周りのテストが書ける。あんまりORMにはならない感じで。
なるべく標準ライブラリ周りの形状以外意識しなくて良いような形が理想。フレームワーク化は避けたい。

バックエンドの実装が複数になるという感じ？

- sql(sqlx)
- inmemory map (internal go code)
- REST
- (other NoSQL db ?)
- (csv, json ?)

まぁ実際のアプリのコードの場合はintegration test的な文脈で利用する予定なのでqueryないしはcommandが使えたらそれでチェックでも良いんじゃとは思う(CQS的なの文脈)。

### 追記

あんまり手は拡げたくないなー。

## memo test codeの設計方針

fixture付近頑張りたくないなー。dbのcreate table的なものはどうしよう？

とりあえず、この記事に似た感じの方針で良い気がする。*testing.Mを受け取るsetup関数をapp libraryに作ってそれを使う(appの持ち物)。テスト関数の中でcreate tableはしない。

https://medium.com/@timakin/go-api-testing-173b97fb23ec

そしてまともにコードを書いていれば*teting.Tを受け取る関数毎でdbの初期化とか不要な気がするし(マルチテナントっぽいDBの設計になるかもしれない。場合によっては)。

並列化したかったらgetDB()みたいなhelper関数を用意してprefork的に立ち上げて置いたものに雑に接続していけば良い気がするし。

これもアプリ側のコードかな。

### 前提

- app libraryとlibraryがある
- app libraryというのはapptest的なパッケージのこと
- libraryが今回のそれ

## 戻り値を渡す形式はbind的なものが良さそう

queryとかの結果を返す部分どうしようかな？値が取得できたら型が決まっている形の方が良い気がしている。json.Decoder()みたいなインターフェイスで良い気がする。

こちらの場合は利用者側で型を指定するからtype assertionで分岐とか面倒な話が出てこないし。bindみたいな形でやるのが良い。

## sessionオブジェクト的なものははじめから作っておいた方が良い？

なんだかんだでsessionオブジェクト的なものは用意しておいた方が良い気がする。dbオブジェクトみたいなものを作ってそこに直接アクセスはあんまり良い方針なさそう。

(なんならやるかはわからないけれどsession単位でrequest, responseを記録して保持しておけると便利かもしれない)

### 追記 名前とか階層構造

そうそう名前をどうするかは悩みどころ。いっそのことdbではなくsession factoryの方が良いかどうか。

一般的には(RDBMSに擬えると)以下のような階層構造になっていそう。

- database
- table
- record (row)

RESTとかだとどうなるんだろう？endpoint(host, service), resource, documentとか？（まぁこれは微妙）

## どれくらいの機能があれば良いんだろう？（なるべく少なめで）

あんまり複雑にはしたくないしORMを作りたくはないなー。メソッドチェインはなるべく避けるような形にしたい。SQLを共通表現として使う方法もありと言えばありなのだけれど今回は避けたいかも。ただ独自の表現や概念を発明はしたくないなー。

ふつうに寄り添うという意味では標準ライブラリに寄り添うという話で [database/sql](https://golang.org/pkg/database/sql/) 辺りに寄り添う形のものが良いのかな。

たぶんjoinは作らない。group byも作らない。もちろん窓関数的なものも再帰的なqueryもなし。

### 追記

真似ると言ってもsqlxみたいにSelectとSelectContextを作るみたいなことはしなくても良い気がする。常にSelectでcontextを受け取るとかで良さそう。

(Selectという名前を採用するかはわからない)

### 追記

`Scan()` などは居る？そんな複雑な（大量のデータ）を取ることはない気がするし。sliceを受け取ってbindくらいのもので良いのではという気がしている。

## 分岐を大本でやりたくはない

ただ個別のバリエーションに対応する時に文字列で分岐する事はなさそう(e.g. database/sqlやsqlxでのmysql,postgresql,sqlite3などの分岐のこと)。

これはバリエーション全体を大本のパッケージが知る必要があるので。

## facade作る？

とりあえずctxを渡したりerrorを返すようなフルの実装を書いてみて、それへのfacade的なものを用意するかももしかしたらみたいな感じでやっていくのが良さそう？sugarが良いかshorthandが良いかはちょっと名前などは決めていないけれど。

## データのやり取りは？

基本は全部model的なオブジェクトを元にやり取りする感じになりそう。
(ただmodelというようなactiveなものではなくdataとかentity(?)とかそういった名前のものの方が近い。いっそのこと構造体)

まぁこの辺りはencoding/jsonとのやり取りと同じ話で別にmapが返ってきても良いのでは？

あと冒頭（？）にも書いた通りアプリ側のコードが適切に育っていればそちらのqueryを使ってやり取りしても良さそうな気がしている。テストコードを書く上では。

なのでinsertもほとんどdataを作ってinsertだけな感じ。
(もしかしたらtrasnaction的なものを用意して一時的にunique keyを外してinsertなどもできたほうが嬉しいかもしれない。ただしこれはその後の発展的な話なような気がするので問題がおきるまで先送り)

## 追記

エラーは何か共通のものがあると便利かもなーとは思う。
pkg/errorsのCause()的なものも欲しいのだけれど。これを隠すようなものは作りたくないかも？必ずCause()を呼んだら元のエラーが返されてきて欲しい。

何か特別なメソッド生やす？それはそれで。。`Causes()`みたいなメソッドでslicesが変えるのは無しな気がする。

## 追記 out of context

理想の話をすると、というかこれとはスコープの異なる話をするとtableのschema的な情報が取れたら便利かもなーという気はしている。

## 追記

理想的にはゆるふわじゃなく型があった方が良いけれど、それのために二重にschemaを定義するみたいなことは避けたいかも。

ただdatabase not found, table not found, field not found的なものは手軽にはあくしたいという気持ちもあったりするかも。

## 追記

どのタイミングでdbにconnectするのが良いんだろうなー。
