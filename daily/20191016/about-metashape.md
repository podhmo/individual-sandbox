(途中）

### コード生成(コード出力)の話

最近もう少し定義を記述したらおしまいという形にできないかということを考えています。概念的にはdesignという形でDSLを書いてそこからglueコードを生成する[goa](https://github.com/goadesign/goa/tree/1279eaa902f70c8806e522fab807e4fed6033e0b)が近いかもしれません。

また[OpenAPI document](https://swagger.io/specification/)からのコード生成あるいはコードからのOpenAPI documentの生成。あるいはProtocol Buffers経由でのgrpcの定義からのコード生成なども同様のものと考えて良いかもです。

## コード生成に対する違和感

一方でこれらのエコシステムに乗る度に感じる不安は、結局どこかのタイミングで別のプロトコルとのコミュニケーションが発生する。その度に定義を重複させることは避けたいけどどうしよう？あるいはたしかにコード生成によって境界をはっきりとしたインターフェイスと一部のデフォルト実装を出力することが出来はするのだけれど、結局自分たちのコード(ドメイン)とつなぎ合わせる部分で苦しみが発生している。ツライ。というようなことでした。

加えて例えばOpenAPIで生成されるものは、概ねwebAPI由来のrequest/responseのinterfaceを規定する部分なのですが、これとドメイン側のモデルとの差異は開発が進む共に広がっていき、同じ定義のスキーマが使い回せないということは分かってくるのですが(これはpresentation側のmodelと及びentity側のmodelが異なるという話なのでさほど間違いはない。基本的にはpresentation側のmodelの主要素はentity側のmodelのsubsetになる。それらを組み合わせた便利な定義が別途生えてくるのもBFF的には自然)。一方で説明（コメント）などは使いまわしたいという思いが強くなっていきます。

そして幾ら補完が効くとはいえ、いや補完などが効くからこそ、そこそこ複雑な構造の定義同士の橋渡しをしているときには、なんでこんな頭を使わないようなたんぽぽワークで消耗しているんだろうというような思いが頭に登ってきてしまいがちです。

特に開発の初期自体はある特定の領域の定義をルートの定義として扱おうとすることで一定上手く行くように見える辺りが曲者です。

### マークアップはプログラマブルではない

その上でマークアップ的な記述はそれ自体でドキュメントとして完結している部分把握しやすい一方で原理的にプログラマブルではないことにに不満を覚えるようになっていきました。

例えばOAS(OpenAPI Spec)では、APIのエラーレスポンスを詳細に記述したい場合には全てのAPIごとにステータス毎のレスポンスの構造を記述する必要があります(例えばdefault,200,400,403,xxx...)。あるいは特定のエンドポイントのセットをサブモジュールといった形で切り出してマウントするみたいなこともできません。

もちろんこれら自前でプリプロセッサーなりフォーマットを拡張してマクロのようなものを用意してあげたりで解決するものではありますが、それでは独自実装でツライです（ツールのメンテ自体はさほどコストにならないのですが。それは自分自身がハンドリングできてずっと目をかけていられるときだけです。既存のツールは全部動かなくなりますし。丁寧に考えないと仕様策定者がせっかく解決した問題を新たに持ち込むことになったりもします。また独自部分のドキュメントと説明のコストが積み上がっていきます）。

少し脱線しますが、自前で幾つかOASをパースしてコードを出力するようなツールを作ったりもしたのですが、特にOASの全ての仕様をサポートするのがめんどうだったりします。柔軟性を保持するための部分の対応が異様にめんどくさい(とくにrequestのパース周り)、加えて多くのツールが大抵一部の仕様しかサポートしておらず使えるのはそれらの共通部分だけになります。対応している部分と未対応な部分を調査するコストや手間が地味に面倒くささを募らせる（この話は単一の領域(OASのみを主とする)の話なので本題とはずれた話ですが）。


そういうこともあってか最近はopenAPI docからのコード生成

### 独自のコード生成


また現状手元の環境でよく触るのがgoとpythonなのですがgoは[直和型](https://qiita.com/ymtszw/items/dff02ad6350032688676)が素直に気jつｄ

pythonでmypyを騙してfieldにmetadataを付加したクラスを定義してみる。


